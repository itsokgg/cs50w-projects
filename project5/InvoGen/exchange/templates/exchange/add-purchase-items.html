{% extends "exchange/layout.html" %}

{% block title %}Purchase Serialized Items{% endblock %}

{% block body %}
    <script>
        // I got help from ChatGPT on how to generally dynamically render extraformsets using empty_form
        // ChatGpt did not help me with how to apply it to my template with my specific needs
        document.addEventListener("DOMContentLoaded", () => {
            function addFormset(prefix) {
                let addBtn = document.getElementById(`add-to-${prefix}-btn`);
                let totalForms = document.getElementById(`id_${prefix}-TOTAL_FORMS`);
                let emptyFormsetHTML = document.getElementById(`empty-${prefix}-div`).innerHTML;
                let formsetRenderDiv = document.getElementById(`${prefix}-render-div`);
            
                addBtn.addEventListener("click", ()=> {
                    let formCount = parseInt(totalForms.value);
                    let itemNumber = formCount + 1;
                    let newForm = document.createElement("div");
                    
                    // replace all instances of __prefix__
                    newFormHTML = emptyFormsetHTML.replace(/__prefix__/g, formCount);

                    // replace all __itemNumber__ for items
                    if (newFormHTML.includes("__itemNumber__")) {
                        formHTML = newFormHTML.replace(/__itemNumber__/g, itemNumber);
                    } else {
                        formHTML = newFormHTML
                    }
                    
                    newForm.innerHTML = formHTML;
                    formsetRenderDiv.append(newForm);
                    totalForms.value = formCount + 1;
                })

                
            }
            addFormset("formset1");
            addFormset("formset2");
            addFormset("formset3");
        })

        function addExtraUniqueId(element) {
            let itemNumber = element.dataset.itemnumber
            let itemDiv = document.getElementById(`new-item-${itemNumber}`);
            let input = document.createElement("input");
            input.name = `item-${itemNumber}-input`;
            input.classList.add("form-control")
            itemDiv.insertBefore(input, element)
        }
    </script>
    <div class="text-center"><h1>Purchase Items</h1></div>
    <form action="{% url 'add_purchase_items' purchase_id=purchase_id %}" method="POST">
        {% csrf_token %}
        
            
        <div class="mb-3">
            <h3>Serialized Items</h3>
            
            {{ formset1.management_form }}
            <div id="empty-formset1-div" style="display: none" >
                <div id="new-item-__itemNumber__" class="item-container">
                    <h4>Item __itemNumber__</h4>
                    <hr>
                    {{ formset1.empty_form.as_p }}
                    <button onclick="addExtraUniqueId(this)" data-itemNumber="__itemNumber__" type="button" class="btn btn-success">+</button> 
                    
                </div>
            </div>
            
            <div id="formset1-render-div">
                {% for form in formset1 %}
                    <div id="new-item-1" class="item-container">
                        <h4>Item 1</h4>
                        <hr>
                            {{ form.as_p }}
                        <button onclick="addExtraUniqueId(this)" data-itemNumber="1" type="button" class="btn btn-success">+</button>
                    </div>
                {% endfor %}
            </div>
            <p><button id="add-to-formset1-btn" type="button" class="btn btn-secondary">Add Item</button></p>
        </div> 
            
            
        <div class="mb-3">
            <h3>Nonserialized Items</h3>
            
            {{ formset2.management_form }}
            <div id="empty-formset2-div" style="display: none">
                <div class="item-container">
                    <h4>Item __itemNumber__</h4>
                    {{ formset2.empty_form.as_p}}
                </div>
            </div>

            <div id="formset2-render-div">
                <div class="item-container">
                    <h4>Item 1</h4>
                    {% for form in formset2 %}
                        {{ form.as_p }}
                    {% endfor %}
                </div>
            </div>
            <p><button id="add-to-formset2-btn" type="button" class="btn btn-secondary">Add Item</button></p>
        </div>
        
        <div class="mb-3">
            <h3>Other Costs</h3>

            {{ formset3.management_form }}
            <div id="empty-formset3-div" style="display: none">
                <div class="item-container">
                    {{ formset3.empty_form.as_p }}
                </div>
            </div>
            <div id="formset3-render-div">
                <div class="item-container">
                    {% for form in formset3 %}
                        {{ form.as_p }}
                    {% endfor %}
                </div>
            </div>
            <p><button id="add-to-formset3-btn" type="button" class="btn btn-secondary">Add Other Cost</button></p>
        </div>

        <div class="text-center">
            <hr>
            <input class="btn btn-primary" type="submit" value="Save">
        </div>
    </form>
        
{% endblock %}